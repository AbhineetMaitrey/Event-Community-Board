{% extends "base.html" %}

{% block content %}

<div class="bg-white p-4 rounded-3 mb-4 shadow-sm d-flex justify-content-between align-items-center">
    <div>
        <h1 class="mb-0">{{ event.title }}</h1>
        <div class="small text-muted">
            {{ event.date }} ‚Ä¢ {{ event.location }}
        </div>
    </div>
    <div class="text-end">
        {% if status == "CREATOR" %}
            <span class="badge badge-creator">CREATOR</span>
        {% elif status == "MEMBER" %}
            <span class="badge badge-member">MEMBER</span>
        {% endif %}

        {% if event.lifecycle == "upcoming" %}
            <span class="badge badge-upcoming">UPCOMING</span>
        {% elif event.lifecycle == "ongoing" %}
            <span class="badge badge-ongoing">ONGOING</span>
        {% elif event.lifecycle == "completed" %}
            <span class="badge badge-completed">COMPLETED</span>
        {% elif event.lifecycle == "cancelled" %}
            <span class="badge badge-cancelled">CANCELLED</span>
        {% endif %}
    </div>
</div>

{% if event.lifecycle == "cancelled" %}
    <div class="alert alert-danger">
        <strong>‚ö†Ô∏è This event has been cancelled</strong>
        {% if event.cancellation_reason %}
            <br><strong>Reason:</strong> {{ event.cancellation_reason }}
        {% endif %}
    </div>
{% elif event.lifecycle == "completed" %}
    <div class="alert alert-info">
        <strong>‚úì This event has been completed</strong>
    </div>
{% endif %}

<div class="row">
    <!-- LEFT CONTENT -->
    <div class="col-lg-8">

        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Event Details</h5>

                <p>{{ event.description }}</p>

                <ul class="list-unstyled small">

                    <li>
                        <strong>üïí Time:</strong>
                        {{ event.start_time|time:"h:i A" }}
                        {% if event.end_time %}
                            ‚Äì {{ event.end_time|time:"h:i A" }}
                        {% endif %}
                    </li>

                    <li><strong>üìç Location:</strong> {{ event.location }}</li>
                    <li><strong>üèõÔ∏è Mode:</strong> {{ event.mode }}</li>
                    <li><strong>üîó Venue / Link:</strong> {{ event.venue_or_link }}</li>
                    <li><strong>üë§ Hosted by:</strong> {{ event.created_by.username }}</li>
                    <li><strong>üéØ Interest:</strong> {{ event.interest }}</li>
                    <li><strong>üë• Participants:</strong> {{ join_count }}</li>
                </ul>

                <div class="mt-3">
                    <strong>Tags</strong><br>
                    {% for tag in event.tags.all %}
                        <span class="tag-pill">{{ tag.name }}</span>
                    {% empty %}
                        <span class="text-muted">No tags</span>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- ANNOUNCEMENTS -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üì¢ Announcements</h5>
            </div>
            <div class="card-body">

                {% for ann in announcements %}
                    <div class="alert alert-light border">
                        <p>{{ ann.message }}</p>
                        <small class="text-muted">
                            By {{ ann.created_by.username }}
                            on {{ ann.created_at|date:"M d, Y H:i" }}
                        </small>

                        {% if status == "CREATOR" and event.lifecycle != "completed" and event.lifecycle != "cancelled" %}
                            <div class="mt-2">
                                <a href="/events/announcements/edit/{{ ann.id }}/"
                                   class="btn btn-sm btn-outline-primary">Edit</a>
                                <a href="/events/announcements/delete/{{ ann.id }}/"
                                   class="btn btn-sm btn-outline-danger">Delete</a>
                            </div>
                        {% endif %}
                    </div>
                {% empty %}
                    <p class="text-muted">No announcements yet.</p>
                {% endfor %}

                {% if status == "CREATOR" and event.lifecycle == "upcoming" or event.lifecycle == "ongoing" %}
                    <hr>
                    <form method="post">
                        {% csrf_token %}
                        <textarea name="message"
                                  class="form-control mb-2"
                                  rows="3"
                                  placeholder="Write announcement..."
                                  required></textarea>
                        <button class="btn btn-primary">Post Announcement</button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- RIGHT ACTIONS -->
    <div class="col-lg-4">
        <div class="card sticky-card">
            <div class="card-body">
                <h6 class="mb-3">Actions</h6>

                {% if user.is_authenticated %}

                    {% if status == "CREATOR" %}
                        {% if event.lifecycle == "upcoming" or event.lifecycle == "ongoing" %}
                            <a href="/events/edit/{{ event.id }}/"
                               class="btn btn-primary w-100 mb-2">‚úèÔ∏è Edit Event</a>
                            <a href="/events/cancel/{{ event.id }}/"
                               class="btn btn-warning w-100">‚ùå Cancel Event</a>
                        {% else %}
                            <a href="/events/delete/{{ event.id }}/"
                               class="btn btn-danger w-100">üóë Delete Event</a>
                        {% endif %}

                    {% elif status == "MEMBER" %}
                        {% if event.lifecycle == "upcoming" or event.lifecycle == "ongoing" %}
                            <a href="/events/leave/{{ event.id }}/"
                               class="btn btn-danger w-100">Leave Event</a>
                        {% else %}
                            <p class="text-muted text-center">Event Closed</p>
                        {% endif %}

                    {% else %}
                        {% if event.lifecycle == "upcoming" or event.lifecycle == "ongoing" %}
                            <a href="/events/join/{{ event.id }}/"
                               class="btn btn-success w-100">Join Event</a>
                        {% else %}
                            <p class="text-muted text-center">Event Closed</p>
                        {% endif %}
                    {% endif %}

                {% else %}
                    <p class="text-muted text-center">
                        <a href="/accounts/login/">Login</a> to join this event
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}
